@model SistemaAsistencia.Models.User
@{
    ViewData["Title"] = "Perfil de Usuario";
    var attendanceHistory = ViewBag.AttendanceHistory as List<SistemaAsistencia.Models.AttendanceRecord>;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-user"></i> Perfil de Usuario</h2>
                <div>
                    <a href="@Url.Action("Index")" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver a Usuarios
                    </a>
                    <a href="@Url.Action("Edit", new { id = Model.Id })" class="btn btn-warning">
                        <i class="fas fa-edit"></i> Editar Usuario
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Información del Usuario -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-user-circle"></i> Información Personal</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                            <i class="fas fa-user fa-2x text-white"></i>
                        </div>
                    </div>
                    
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Nombre:</strong></td>
                            <td>@Model.Name</td>
                        </tr>
                        <tr>
                            <td><strong>Email:</strong></td>
                            <td>@Model.Email</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha de Ingreso:</strong></td>
                            <td>@(Model.HireDate?.Day ?? 1)/@(Model.HireDate?.Month ?? 1)/@(Model.HireDate?.Year ?? DateTime.Now.Year)</td>
                        </tr>
                        <tr>
                            <td><strong>Estado:</strong></td>
                            <td>
                                @if (Model.IsActive)
                                {
                                    <span class="badge bg-success">Activo</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Inactivo</span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Tipo de Usuario:</strong></td>
                            <td>
                                @if (Model.IsAdmin)
                                {
                                    <span class="badge bg-warning">Administrador</span>
                                }
                                else
                                {
                                    <span class="badge bg-info">Empleado</span>
                                }
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Acciones Rápidas -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6><i class="fas fa-tools"></i> Acciones Rápidas</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="@Url.Action("ShowQr", new { id = Model.Id })" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-qrcode"></i> Ver Código QR
                        </a>
                        <a href="@Url.Action("AttendanceHistory", "User", new { userId = Model.Id })" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-history"></i> Historial Completo
                        </a>
                        @if (!Model.IsAdmin)
                        {
                            <a href="@Url.Action("ManualRecord", new { userId = Model.Id })" class="btn btn-outline-warning btn-sm">
                                <i class="fas fa-clock"></i> Registro Manual
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Historial de Asistencia Reciente -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> Historial de Asistencia Reciente</h5>
                </div>
                <div class="card-body">
                    @if (attendanceHistory != null && attendanceHistory.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Hora</th>
                                        <th>Tipo</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var record in attendanceHistory)
                                    {
                                        <tr>
                                            <td>@record.Timestamp.ToString("dd/MM/yyyy")</td>
                                            <td>@record.Timestamp.ToString("HH:mm")</td>
                                            <td>
                                                @if (record.RecordType == "Entrada")
                                                {
                                                    <span class="badge bg-success">Entrada</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-info">Salida</span>
                                                }
                                            </td>
                                            <td>
                                                @{
                                                    // Usar horarios por defecto para simplificar
                                                    var lateThreshold = new TimeSpan(9, 30, 0);
                                                    var earlyThreshold = new TimeSpan(17, 30, 0);
                                                    
                                                    bool isLate = record.RecordType == "Entrada" && record.Timestamp.TimeOfDay > lateThreshold;
                                                    bool isEarly = record.RecordType == "Salida" && record.Timestamp.TimeOfDay < earlyThreshold;
                                                }
                                                
                                                @if (isLate)
                                                {
                                                    <span class="badge bg-warning">Tarde</span>
                                                }
                                                else if (isEarly)
                                                {
                                                    <span class="badge bg-warning">Temprano</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success">A tiempo</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="text-center mt-3">
                            <a href="@Url.Action("AttendanceHistory", "User", new { userId = Model.Id })" class="btn btn-primary">
                                <i class="fas fa-eye"></i> Ver Historial Completo
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No hay registros de asistencia para este usuario.</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Estadísticas Rápidas -->
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-calendar-check fa-2x text-success mb-2"></i>
                            <h5>@(attendanceHistory?.Count(r => r.RecordType == "Entrada") ?? 0)</h5>
                            <small class="text-muted">Días Asistidos</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                            <h5>@(attendanceHistory?.Count(r => r.RecordType == "Entrada" && r.Timestamp.TimeOfDay > new TimeSpan(9, 30, 0)) ?? 0)</h5>
                            <small class="text-muted">Llegadas Tarde</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-clock fa-2x text-info mb-2"></i>
                            <h5>@(attendanceHistory?.Count(r => r.RecordType == "Salida" && r.Timestamp.TimeOfDay < new TimeSpan(17, 30, 0)) ?? 0)</h5>
                            <small class="text-muted">Salidas Tempranas</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
