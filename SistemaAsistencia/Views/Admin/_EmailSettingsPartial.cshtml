@model SistemaAsistencia.Models.EmailSettingsViewModel

<div class="card mt-4">
    <div class="card-header">
        <h5>Configuraci√≥n de Correo Electr√≥nico</h5>
    </div>
    <div class="card-body">
        <form asp-action="UpdateEmailSettings" method="post">
            <div class="mb-3">
                <div class="form-check">
                    <input asp-for="EmailEnabled" class="form-check-input" type="checkbox" id="emailEnabled" />
                    <label class="form-check-label" for="emailEnabled">
                        Habilitar env√≠o de correos electr√≥nicos
                    </label>
                </div>
            </div>

            <div id="emailConfig" style="display: none;">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="SmtpServer" class="form-label"></label>
                        <input asp-for="SmtpServer" class="form-control" placeholder="smtp.gmail.com" />
                        <span asp-validation-for="SmtpServer" class="text-danger"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="SmtpPort" class="form-label"></label>
                        <input asp-for="SmtpPort" class="form-control" type="number" />
                        <span asp-validation-for="SmtpPort" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="EmailUsername" class="form-label"></label>
                        <input asp-for="EmailUsername" class="form-control" placeholder="tu-email@gmail.com" />
                        <span asp-validation-for="EmailUsername" class="text-danger"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="EmailPassword" class="form-label"></label>
                        <input asp-for="EmailPassword" class="form-control" type="password" placeholder="Contrase√±a de aplicaci√≥n" />
                        <span asp-validation-for="EmailPassword" class="text-danger"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="FromEmail" class="form-label"></label>
                        <input asp-for="FromEmail" class="form-control" placeholder="noreply@empresa.com" />
                        <span asp-validation-for="FromEmail" class="text-danger"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="FromName" class="form-label"></label>
                        <input asp-for="FromName" class="form-control" placeholder="Sistema de Asistencia" />
                        <span asp-validation-for="FromName" class="text-danger"></span>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Importante:</strong> Para probar la conexi√≥n, primero debes <strong>GUARDAR</strong> la configuraci√≥n de email y luego hacer clic en "Probar Conexi√≥n".
                    <br><br>
                    <strong>Nota:</strong> Para Gmail, necesitas usar una "Contrase√±a de aplicaci√≥n" en lugar de tu contrase√±a normal. 
                    <a href="https://support.google.com/accounts/answer/185833" target="_blank">Ver c√≥mo crear una contrase√±a de aplicaci√≥n</a>
                    <br><br>
                    <strong>üìñ Gu√≠a completa:</strong> <a href="~/CONFIGURAR_GMAIL.md" target="_blank">Ver gu√≠a de configuraci√≥n de Gmail</a>
                </div>

                <!-- Plantillas de Email -->
                <hr>
                <h6>Plantillas de Email</h6>
                
                <div class="mb-3">
                    <label asp-for="WelcomeEmailTemplate" class="form-label"></label>
                    <textarea asp-for="WelcomeEmailTemplate" class="form-control" rows="8" placeholder="Plantilla para emails de bienvenida"></textarea>
                    <span asp-validation-for="WelcomeEmailTemplate" class="text-danger"></span>
                    <div class="form-text">
                        <strong>Variables disponibles:</strong> {CompanyName}, {UserName}, {QrCode}, {SystemUrl}
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="AttendanceEmailTemplate" class="form-label"></label>
                    <textarea asp-for="AttendanceEmailTemplate" class="form-control" rows="8" placeholder="Plantilla para emails de asistencia"></textarea>
                    <span asp-validation-for="AttendanceEmailTemplate" class="text-danger"></span>
                    <div class="form-text">
                        <strong>Variables disponibles:</strong> {CompanyName}, {UserName}, {RecordType}, {Date}, {Time}, {Status}
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between">
                <a href="@Url.Action("Index")" class="btn btn-secondary">Volver al Panel</a>
                <div>
                    <button type="button" id="testConnectionBtn" class="btn btn-info me-2">
                        <i class="fas fa-wifi"></i> Probar Conexi√≥n
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-envelope"></i> Guardar Configuraci√≥n de Email
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const emailEnabledCheckbox = document.getElementById('emailEnabled');
        const emailConfigDiv = document.getElementById('emailConfig');
        
        // Funci√≥n para mostrar/ocultar configuraci√≥n de email
        function toggleEmailConfig() {
            if (emailEnabledCheckbox.checked) {
                emailConfigDiv.style.display = 'block';
            } else {
                emailConfigDiv.style.display = 'none';
            }
        }
        
        // Event listener para el checkbox
        emailEnabledCheckbox.addEventListener('change', toggleEmailConfig);
        
        // Mostrar configuraci√≥n si ya est√° habilitada
        toggleEmailConfig();
        
        // Bot√≥n de prueba de conexi√≥n
        const testConnectionBtn = document.getElementById('testConnectionBtn');
        if (testConnectionBtn) {
            testConnectionBtn.addEventListener('click', async function() {
                const originalText = testConnectionBtn.innerHTML;
                testConnectionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Probando...';
                testConnectionBtn.disabled = true;
                
                try {
                    const response = await fetch('@Url.Action("TestEmailConnection")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('‚úÖ Conexi√≥n SMTP exitosa! La configuraci√≥n de email est√° funcionando correctamente.');
                    } else {
                        alert('‚ùå Error de conexi√≥n: ' + (result.message || 'No se pudo conectar al servidor SMTP'));
                    }
                } catch (error) {
                    alert('‚ùå Error al probar la conexi√≥n: ' + error.message);
                } finally {
                    testConnectionBtn.innerHTML = originalText;
                    testConnectionBtn.disabled = false;
                }
            });
        }
    });
</script>
